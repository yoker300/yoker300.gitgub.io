<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartList AI</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="./manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { overscroll-behavior: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from "https://esm.sh/react@18.2.0";
        import ReactDOM from "https://esm.sh/react-dom@18.2.0/client";
        import { 
            Settings, Mic, Plus, ChevronLeft, X, Zap, MapPin, 
            ShoppingBag, Clock, Smartphone, Trash2, Check, 
            Moon, Sun, User, ChevronRight, Edit3, Save,
            MoreVertical, LayoutGrid, Sparkles, ChefHat, Loader,
            BookOpen, Utensils, Share2, Image as ImageIcon,
            Wheat, Ban, Camera, Type, AlignLeft
        } from "https://esm.sh/lucide-react@0.292.0";

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail', err));
        }

        // --- GEMINI SERVICE ---
        const GeminiService = {
            cleanJson: (text) => text.replace(/```json/g, '').replace(/```/g, '').trim(),
            parseShoppingList: async (inputText) => {
                await new Promise(r => setTimeout(r, 1000)); 
                return [
                    { name: "Simulated Item", category: "Pantry", qty: 1, urgent: true, icon: "ðŸ“¦" },
                    { name: "Simulated Item 2", category: "Dairy", qty: 2, urgent: false, icon: "ðŸ¥›" }
                ];
            },
            generateIngredients: async (dishName) => {
                await new Promise(r => setTimeout(r, 1000));
                return [
                    { name: "Flour", category: "Baking", qty: 2, icon: "ðŸŒ¾" },
                    { name: "Eggs", category: "Dairy", qty: 3, icon: "ðŸ¥š" }
                ];
            },
            improveItem: async (item) => {
                console.log("Gemini checking:", item.name);
                await new Promise(r => setTimeout(r, 800)); 
                const lower = item.name.toLowerCase();
                let corrected = { ...item };
                if (lower.includes("spag") || lower.includes("pasta")) {
                    corrected.name = "Spaghetti"; corrected.category = "Pantry"; corrected.icon = "ðŸ";
                } else if (lower.includes("avoc")) {
                    corrected.name = "Avocado"; corrected.category = "Produce"; corrected.icon = "ðŸ¥‘";
                } else {
                    corrected.category = autoCategorize(corrected.name);
                }
                return corrected;
            }
        };

        const autoCategorize = (name) => {
            const n = name.toLowerCase();
            if (n.includes('milk') || n.includes('cheese') || n.includes('egg')) return 'Dairy';
            if (n.includes('bread')) return 'Bakery';
            if (n.includes('apple') || n.includes('tomato')) return 'Produce';
            return 'Other'; 
        };

        // --- DATA ---
        const DEFAULT_SETTINGS = { darkMode: true, fontSize: 'normal', username: "My User", email: "user@gmail.com", stores: ['Supermarket', 'Bakery'], smartQuantities: [{ id: 1, item: 'Eggs', presets: [6, 12, 30] }] };
        const INITIAL_LISTS = [{ id: 1, name: "Weekly Groceries", collaborators: [], items: [{ id: 101, name: 'Milk', category: 'Dairy', urgent: false, gf: false, qty: 1, store: 'Supermarket', icon: 'ðŸ¥›', notes: '' }] }];
        const INITIAL_RECIPES = [{ id: 1, name: "Pancakes", icon: "ðŸ¥ž", image: "", ingredients: [{id: 'r1', name: "Flour", category: "Baking", qty: 2, icon: "ðŸŒ¾", gf: false}], collaborators: [] }];

        // --- COMPONENTS ---
        const GlutenFreeIcon = ({ active }) => (
            <div className="relative flex items-center justify-center w-6 h-6">
                <Wheat size={20} className={active ? "text-green-500" : "text-slate-400"} />
                {active && <Ban size={24} className="text-red-500/80 opacity-80 absolute" />}
            </div>
        );

        // --- MAIN APP ---
        function App() {
            const [activeTab, setActiveTab] = useState('phone'); 
            const [isRealWatch, setIsRealWatch] = useState(false);
            const [currentView, setCurrentView] = useState('lists'); 
            const [settings, setSettings] = useState(() => JSON.parse(localStorage.getItem('sl_settings')) || DEFAULT_SETTINGS);
            const [lists, setLists] = useState(() => JSON.parse(localStorage.getItem('sl_lists')) || INITIAL_LISTS);
            const [recipes, setRecipes] = useState(INITIAL_RECIPES);
            const [activeListId, setActiveListId] = useState(null);
            const [activeRecipeId, setActiveRecipeId] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);
            const [showUrgent, setShowUrgent] = useState(false);
            const [showAI, setShowAI] = useState(false);
            const [watchView, setWatchView] = useState('lists');

            useEffect(() => {
                const checkSize = () => {
                    const isWatch = window.innerWidth < 300;
                    setIsRealWatch(isWatch);
                    if(isWatch) setActiveTab('watch');
                };
                checkSize();
                window.addEventListener('resize', checkSize);
                return () => window.removeEventListener('resize', checkSize);
            }, []);

            useEffect(() => localStorage.setItem('sl_settings', JSON.stringify(settings)), [settings]);
            useEffect(() => localStorage.setItem('sl_lists', JSON.stringify(lists)), [lists]);

            const getTheme = () => {
                const isDark = settings.darkMode;
                let bgApp = isDark ? 'bg-slate-950' : 'bg-slate-200';
                let bgCard = isDark ? 'bg-slate-900' : 'bg-white';
                let txt = isDark ? 'text-slate-100' : 'text-slate-900';
                let txtSec = isDark ? 'text-slate-400' : 'text-slate-500';
                let brd = isDark ? 'border-slate-800' : 'border-slate-300';
                if (showUrgent) {
                    bgApp = isDark ? 'bg-red-950' : 'bg-red-100';
                    bgCard = isDark ? 'bg-red-900/40' : 'bg-white';
                    brd = isDark ? 'border-red-900' : 'border-red-200';
                }
                return { bgApp, bgCard, txt, txtSec, brd };
            };
            const th = getTheme();

            const activeList = lists.find(l => l.id === activeListId);
            const itemsToShow = activeList ? (showUrgent ? activeList.items.filter(i => i.urgent) : activeList.items) : [];
            const grouped = itemsToShow.reduce((acc, i) => { (acc[i.category] = acc[i.category] || []).push(i); return acc; }, {});

            // RENDERERS
            const renderWatch = () => (
                <div className={`w-full h-full flex flex-col bg-black text-white ${!isRealWatch ? 'rounded-full border-[8px] border-slate-700 w-[220px] h-[220px] relative overflow-hidden' : 'fixed inset-0'}`}>
                    {watchView === 'lists' ? (
                        <>
                            <div className="pt-8 pb-2 text-center border-b border-slate-800 z-10"><h2 className="text-[10px] font-bold text-blue-400 uppercase">My Lists</h2></div>
                            <div className="flex-1 overflow-y-auto px-2 py-2 space-y-2 no-scrollbar">
                                {lists.map(l => (
                                    <button key={l.id} onClick={() => { setActiveListId(l.id); setWatchView('items'); }} className="w-full p-2 bg-slate-800 rounded-xl text-center border border-slate-700">
                                        <div className="text-[10px] font-bold truncate">{l.name}</div>
                                        <div className="text-[8px] text-slate-400">{l.items.length} items</div>
                                    </button>
                                ))}
                            </div>
                        </>
                    ) : activeList ? (
                        <>
                            <div className="pt-8 pb-2 px-3 flex items-center justify-between border-b border-slate-800 z-10">
                                <button onClick={() => setWatchView('lists')}><ChevronLeft size={14} /></button>
                                <h2 className="text-[10px] font-bold text-blue-400 uppercase truncate px-1">{activeList.name}</h2>
                                <div className="w-4"></div>
                            </div>
                            <div className="flex-1 overflow-y-auto px-1 py-1 no-scrollbar text-left" style={{maskImage: 'linear-gradient(to bottom, transparent, black 10%, black 90%, transparent)'}}>
                                <div className="h-2"></div>
                                {Object.entries(grouped).map(([cat, its]) => (
                                    <div key={cat} className="mb-2">
                                        <div className="text-[9px] text-slate-500 font-bold uppercase pl-3">{cat}</div>
                                        {its.map(i => (
                                            <div key={i.id} className={`flex items-center p-2 mb-1 rounded-lg ${i.urgent ? 'bg-red-900/40 border border-red-800' : 'bg-slate-800 border border-slate-700'}`}>
                                                <span className="text-sm mr-2">{i.icon}</span>
                                                <span className="text-[10px] truncate flex-1">{i.name}</span>
                                                {i.gf && <Wheat size={10} className="text-green-400 mx-1" />}
                                                {i.qty > 1 && <span className="text-[8px] bg-blue-900 px-1 rounded">{i.qty}</span>}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                                <div className="h-6"></div>
                            </div>
                            <div className="absolute bottom-2 w-full flex justify-center z-20">
                                <button onClick={() => setShowUrgent(!showUrgent)} className={`w-8 h-8 rounded-full flex items-center justify-center ${showUrgent ? 'bg-red-600' : 'bg-slate-800 text-slate-400'}`}><Zap size={12} fill="currentColor" /></button>
                            </div>
                        </>
                    ) : <div className="p-4 text-center text-xs">Select List on Phone</div>}
                </div>
            );

            const renderPhone = () => (
                <div className={`w-[360px] h-[720px] rounded-[3rem] shadow-2xl border-[8px] ${settings.darkMode ? 'border-slate-800 bg-slate-900' : 'border-slate-800 bg-slate-100'} relative overflow-hidden flex flex-col`}>
                    {currentView === 'settings' && (
                        <div className={`h-full flex flex-col ${th.bgApp} ${th.txt}`}>
                            <div className={`p-4 flex items-center gap-3 border-b ${th.brd} ${th.bgCard}`}><button onClick={() => setCurrentView('lists')}><ChevronLeft /></button><h2 className="text-xl font-bold">Settings</h2></div>
                            <div className="p-4 space-y-6">
                                <div className={`p-4 rounded-2xl ${th.bgCard} shadow-sm space-y-4`}><div className="flex justify-between items-center"><span className="font-bold">Dark Mode</span><button onClick={() => setSettings({...settings, darkMode: !settings.darkMode})} className={`w-12 h-6 rounded-full p-1 ${settings.darkMode ? 'bg-blue-600' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow transition-transform ${settings.darkMode ? 'translate-x-6' : ''}`}></div></button></div></div>
                                <div className={`p-4 rounded-2xl ${th.bgCard} shadow-sm space-y-4`}>
                                    <div className="flex justify-between items-center"><span className="font-bold">Smart Quantities</span><button onClick={() => { const item = prompt("Item Name"); if(item) setSettings({...settings, smartQuantities: [...settings.smartQuantities, {id: Date.now(), item, presets: [6, 12, 24]}]}); }} className="bg-blue-100 text-blue-600 p-1 rounded"><Plus size={16}/></button></div>
                                    <div className="space-y-2">{settings.smartQuantities.map(sq => (
                                        <div key={sq.id} className={`flex justify-between p-2 border ${th.brd} rounded-lg`}><div><div className="font-bold text-sm">{sq.item}</div><div className="text-xs opacity-50">{sq.presets.join(', ')}</div></div><button onClick={() => setSettings({...settings, smartQuantities: settings.smartQuantities.filter(x => x.id !== sq.id)})} className="text-red-500"><Trash2 size={14}/></button></div>
                                    ))}</div>
                                </div>
                            </div>
                        </div>
                    )}
                    {currentView === 'lists' && (
                        <div className={`h-full flex flex-col ${th.bgApp} ${th.txt}`}>
                            <div className={`p-6 pt-12 flex justify-between items-center ${th.bgCard} border-b ${th.brd}`}><div><h1 className="text-2xl font-bold">My Lists</h1><p className={`text-sm ${th.txtSec}`}>Welcome, {settings.username}</p></div><div className="flex gap-2"><button onClick={() => setCurrentView('settings')} className="p-3 rounded-full hover:bg-black/10"><Settings size={20}/></button></div></div>
                            <div className="p-4 space-y-4 flex-1 overflow-y-auto">{lists.map(l => (<div key={l.id} onClick={() => { setActiveListId(l.id); setCurrentView('detail'); }} className={`p-5 rounded-2xl ${th.bgCard} shadow-sm border ${th.brd} active:scale-95 transition-all cursor-pointer relative`}><h3 className="text-xl font-bold">{l.name}</h3><div className={`text-xs uppercase font-bold ${th.txtSec}`}>{l.items.length} Items</div><ChevronRight className={`absolute right-4 top-6 ${th.txtSec}`} /></div>))}<button onClick={() => setLists([...lists, {id: Date.now(), name: "New List", items: []}])} className={`w-full py-4 border-2 border-dashed ${th.brd} rounded-2xl font-bold ${th.txtSec} flex justify-center items-center gap-2`}><Plus /> New List</button></div>
                        </div>
                    )}
                    {currentView === 'detail' && activeList && (
                        <div className={`h-full flex flex-col ${th.bgApp} ${th.txt}`}>
                            <div className={`pt-12 pb-3 px-4 ${th.bgCard} border-b ${th.brd} flex justify-between items-center sticky top-0 z-20`}><div className="flex items-center gap-2"><button onClick={() => setCurrentView('lists')}><ChevronLeft /></button><div><h1 className="text-xl font-bold leading-none">{activeList.name}</h1><span className={`text-[10px] uppercase font-bold ${th.txtSec}`}>{itemsToShow.length} Items</span></div></div><button onClick={() => setShowUrgent(!showUrgent)} className={`p-2 rounded-full ${showUrgent ? 'bg-red-600 text-white animate-pulse' : 'bg-slate-100 dark:bg-slate-800'}`}><Zap size={20} fill={showUrgent ? "currentColor" : "none"} /></button></div>
                            <div className="flex-1 overflow-y-auto p-4 scrollbar-hide">{Object.entries(grouped).map(([cat, its]) => (<div key={cat} className="mb-6"><h3 className={`text-[10px] font-bold uppercase px-1 mb-2 ${th.txtSec}`}>{cat}</h3><div className={`rounded-2xl border ${th.brd} ${th.bgCard} overflow-hidden`}>{its.map(i => (<div key={i.id} onClick={() => setSelectedItem(i)} className={`flex items-center p-3 border-b ${th.brd} hover:bg-black/5 cursor-pointer ${i.urgent ? 'bg-red-500/10' : ''}`}><span className="text-2xl mr-3">{i.icon}</span><div className="flex-1"><div className={`font-bold ${i.urgent ? 'text-red-500' : ''}`}>{i.name}</div>{i.store && <div className={`text-[10px] ${th.txtSec}`}><MapPin size={8} className="inline"/> {i.store}</div>}</div>{i.qty > 1 && <span className="text-xs font-bold bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded mx-2">x{i.qty}</span>}{i.gf && <Wheat size={14} className="text-green-500" />}</div>))}</div></div>))}</div>
                            <div className="absolute bottom-6 right-6 flex gap-3"><button onClick={() => setShowAI(true)} className="w-14 h-14 bg-gradient-to-tr from-purple-600 to-blue-500 rounded-2xl shadow-lg text-white flex items-center justify-center"><Sparkles/></button><button onClick={() => { const ni = {id: Date.now(), name: 'New Item', category: 'Other', qty: 1, urgent: false, icon: 'ðŸ“¦', gf: false, store: '', notes: ''}; setLists(prev => prev.map(l => l.id === activeListId ? {...l, items: [...l.items, ni]} : l)); setSelectedItem(ni); }} className={`w-14 h-14 ${showUrgent ? 'bg-red-600' : 'bg-slate-900'} text-white rounded-2xl shadow-lg flex items-center justify-center`}><Plus/></button></div>
                        </div>
                    )}
                </div>
            );

            // ITEM MODAL
            const renderItemModal = () => {
                if(!selectedItem) return null;
                const smartQty = settings.smartQuantities.find(sq => selectedItem.name.toLowerCase().includes(sq.item.toLowerCase()));
                const updateSel = (mod) => { setSelectedItem({ ...selectedItem, ...mod }); };
                const save = async () => {
                    const refined = await GeminiService.improveItem(selectedItem);
                    setLists(prev => prev.map(l => l.id === activeListId ? {...l, items: l.items.map(i => i.id === selectedItem.id ? refined : i)} : l));
                    setSelectedItem(null);
                };
                const del = () => { setLists(prev => prev.map(l => l.id === activeListId ? {...l, items: l.items.filter(i => i.id !== selectedItem.id)} : l)); setSelectedItem(null); };

                return (
                    <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm" onClick={() => setSelectedItem(null)}>
                        <div className={`w-full sm:w-[90%] max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col ${th.bgCard} ${th.txt}`} onClick={e => e.stopPropagation()}>
                            <div className={`flex items-center gap-4 p-5 border-b ${th.brd}`}><div className="text-3xl p-2 bg-slate-100 dark:bg-slate-800 rounded-xl"><input className="bg-transparent w-10 text-center outline-none" value={selectedItem.icon} onChange={e => updateSel({icon: e.target.value})}/></div><div className="flex-1"><input className="text-lg font-bold bg-transparent outline-none w-full" value={selectedItem.name} onChange={e => updateSel({name: e.target.value})} /><span className="text-[10px] font-bold opacity-50 uppercase">{selectedItem.category}</span></div><button onClick={() => setSelectedItem(null)} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full"><X size={18}/></button></div>
                            <div className="p-5 space-y-4">
                                <div className={`p-3 rounded-xl border ${th.brd} flex items-center justify-between`}><span className="text-xs font-bold opacity-70 uppercase">Qty</span>{smartQty ? (<div className="flex gap-2">{smartQty.presets.map(p => <button key={p} onClick={() => updateSel({qty: p})} className={`w-8 h-8 rounded-lg font-bold text-sm ${selectedItem.qty===p ? 'bg-blue-600 text-white' : 'bg-slate-100 dark:bg-slate-700'}`}>{p}</button>)}</div>) : (<div className="flex items-center gap-3"><button onClick={() => updateSel({qty: Math.max(1, selectedItem.qty-1)})} className="w-8 h-8 rounded-full border flex items-center justify-center">-</button><span className="font-bold">{selectedItem.qty}</span><button onClick={() => updateSel({qty: selectedItem.qty+1})} className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center">+</button></div>)}</div>
                                <div><div className="flex items-center gap-2 mb-2"><MapPin size={14} className={th.txtSec} /><input value={selectedItem.store} onChange={e => updateSel({store: e.target.value})} placeholder="Store..." className={`flex-1 bg-transparent border-b ${th.brd} text-sm outline-none`} /></div><div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">{settings.stores.map(s => <button key={s} onClick={() => updateSel({store: s})} className={`px-2 py-1 rounded text-[10px] font-bold border whitespace-nowrap ${selectedItem.store === s ? 'bg-blue-600 text-white' : 'opacity-70'}`}>{s}</button>)}</div></div>
                                <div className="flex gap-3"><button onClick={() => updateSel({urgent: !selectedItem.urgent})} className={`flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 transition-all ${selectedItem.urgent ? 'bg-red-500/10 border-red-500 text-red-500' : 'opacity-60'}`}><Zap size={16} fill={selectedItem.urgent ? "currentColor" : "none"} /><span className="text-xs font-bold">Urgent</span></button><button onClick={() => updateSel({gf: !selectedItem.gf})} className={`flex-1 py-3 rounded-xl border flex items-center justify-center gap-2 transition-all ${selectedItem.gf ? 'bg-green-500/10 border-green-500 text-green-600' : 'opacity-60'}`}><GlutenFreeIcon active={selectedItem.gf} /><span className="text-xs font-bold">GF</span></button></div>
                                <div className="flex items-start gap-2"><AlignLeft size={16} className={`mt-2 ${th.txtSec}`} /><textarea value={selectedItem.notes || ''} onChange={e => updateSel({notes: e.target.value})} placeholder="Details..." className={`flex-1 p-2 rounded-xl border ${th.brd} bg-transparent text-sm outline-none resize-none h-16`} /></div>
                            </div>
                            <div className="p-5 pt-0 flex gap-3"><button onClick={del} className="p-3 bg-red-100 text-red-500 rounded-xl"><Trash2 size={20}/></button><button onClick={save} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold text-sm shadow-md">Save Changes</button></div>
                        </div>
                    </div>
                );
            };

            const renderAI = () => {
                if(!showAI) return null;
                return (
                    <div className="absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm" onClick={() => setShowAI(false)}>
                        <div className={`w-full sm:w-[90%] max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative z-10 flex flex-col ${th.bgCard} ${th.txt}`} onClick={e => e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Sparkles className="text-blue-500"/> Smart Add</h3>
                            <textarea className={`w-full p-4 rounded-2xl h-32 resize-none outline-none border ${th.brd} bg-transparent mb-4`} placeholder="e.g. 6 eggs, milk, urgent apples" id="aiInput"></textarea>
                            <button onClick={async () => {
                                const txt = document.getElementById('aiInput').value;
                                if(txt) {
                                    const items = await GeminiService.parseShoppingList(txt);
                                    setLists(prev => prev.map(l => l.id === activeListId ? {...l, items: [...l.items, ...items.map(i => ({...i, id: Date.now()+Math.random(), gf: false, store: '', notes: ''}))]} : l));
                                    setShowAI(false);
                                }
                            }} className="w-full py-4 rounded-2xl font-bold text-lg shadow-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white">Generate</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full w-full flex items-center justify-center">
                    {!isRealWatch && (
                        <div className="fixed top-4 left-4 flex gap-2 z-50">
                            <button onClick={() => setActiveTab('phone')} className="bg-white p-2 rounded shadow text-black"><Smartphone/></button>
                            <button onClick={() => setActiveTab('watch')} className="bg-white p-2 rounded shadow text-black"><Clock/></button>
                        </div>
                    )}
                    {activeTab === 'phone' && !isRealWatch && renderPhone()}
                    {activeTab === 'watch' && isRealWatch && renderWatch()}
                    {activeTab === 'watch' && !isRealWatch && <div className={`w-[220px] h-[220px] rounded-full border-[8px] border-slate-700 shadow-2xl overflow-hidden relative flex flex-col items-center bg-black`}>{renderWatch()}</div>}
                    {renderItemModal()}
                    {renderAI()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>